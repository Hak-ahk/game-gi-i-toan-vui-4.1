<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Quiz Game</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons (if needed, though we'll use emojis/SVGs) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right bottom, #6a11cb, #2575fc); /* Attractive gradient background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Prevent scroll for fireworks */
        }

        .game-container {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            padding: 30px;
            width: 90%;
            max-width: 800px;
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 20px;
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .question-box {
            background-color: #f0f9ff; /* Light blue background */
            border: 2px solid #bfdbfe; /* Blue border */
            border-radius: 15px;
            padding: 25px;
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a202c;
            min-height: 120px; /* Ensure consistent height */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Adjusted minmax for smaller buttons */
            gap: 15px;
            margin-top: 20px;
        }

        .option-button {
            background-color: #e0f2fe; /* Lighter blue */
            color: #1e40af; /* Darker blue text */
            padding: 12px 20px; /* Reduced padding for smaller buttons */
            border-radius: 12px;
            font-size: 1.3rem; /* Increased font size */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #93c5fd; /* Blue border */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 60px; /* Adjusted min-height */
        }

        .option-button:hover {
            background-color: #bfdbfe; /* Slightly darker on hover */
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .option-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .option-button.correct {
            background-color: #d1fae5; /* Light green for correct */
            border-color: #34d399; /* Green border */
            color: #065f46; /* Dark green text */
            animation: flashCorrect 0.5s ease-out;
        }

        .option-button.incorrect {
            background-color: #fee2e2; /* Light red for incorrect */
            border-color: #ef4444; /* Red border */
            color: #991b1b; /* Dark red text */
            animation: shake 0.3s ease-in-out;
        }

        @keyframes flashCorrect {
            0% { background-color: #d1fae5; }
            50% { background-color: #a7f3d0; }
            100% { background-color: #d1fae5; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .message-box {
            background-color: #fff;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-top: 20px;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .message-box.show {
            opacity: 1;
            transform: translateY(0);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .control-button {
            background: linear-gradient(to right, #4ade80, #22c55e); /* Green gradient */
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: visible; /* Allow hint text to overflow */
        }

        .control-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        }

        .control-button:active {
            transform: translateY(0);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }

        .control-button.reset {
            background: linear-gradient(to right, #f87171, #ef4444); /* Red gradient */
        }
        .control-button.hint {
            background: linear-gradient(to right, #60a5fa, #3b82f6); /* Blue gradient */
        }

        .hint-text {
            position: absolute;
            bottom: calc(100% + 10px); /* Position slightly above the button, add some space */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.9); /* Slightly darker for better contrast */
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            text-align: center; /* Center the text */
            max-width: 250px; /* Limit width to prevent overflow */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 10;
            pointer-events: none; /* Allow clicks to pass through */
        }

        /* New rule for showing hint text */
        .hint-text.show-hint {
            opacity: 1;
            visibility: visible;
        }

        #fireworks-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none; /* Allows interaction with elements behind the canvas */
            z-index: 9999; /* Ensure it's on top */
        }

        .start-screen {
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            padding: 50px;
            width: 90%;
            max-width: 600px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 30px;
            animation: fadeIn 1s ease-out;
        }

        .start-screen h1 {
            font-size: 3rem;
            font-weight: 700;
            color: #2575fc;
            margin-bottom: 20px;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        }

        .start-screen p {
            font-size: 1.2rem;
            color: #4a5568;
            line-height: 1.6;
        }

        .start-button {
            background: linear-gradient(to right, #22c55e, #10b981); /* Green gradient */
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .start-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.3);
        }

        .start-button:active {
            transform: translateY(0);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .game-container, .start-screen {
                padding: 20px;
                width: 95%;
            }
            .question-box {
                font-size: 1.2rem;
                padding: 15px;
                min-height: 100px;
            }
            .options-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* Further adjustment for smaller screens */
            }
            .option-button {
                font-size: 1.1rem; /* Adjusted font size for mobile */
                padding: 10px 15px; /* Adjusted padding for mobile */
                min-height: 50px;
            }
            .controls {
                flex-direction: column;
                gap: 10px;
            }
            .control-button {
                width: 100%;
                padding: 12px 20px;
            }
            .start-screen h1 {
                font-size: 2.5rem;
            }
            .start-screen p {
                font-size: 1rem;
            }
            .start-button {
                padding: 15px 30px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div id="start-screen" class="start-screen">
        <h1>Chào mừng đến với Trò chơi Đố vui Toán học!</h1>
        <p>Kiểm tra kỹ năng giải toán của bạn với một loạt các bài toán đố vui nhộn và thử thách. Nhấn nút "Bắt đầu" để bắt đầu cuộc phiêu lưu của bạn!</p>
        <button id="start-game-button" class="start-button">Bắt đầu</button>
    </div>

    <div id="game-container" class="game-container hidden">
        <div class="header">
            <div class="text-xl font-bold text-blue-700">Câu hỏi: <span id="question-count">0/0</span></div>
            <div class="text-xl font-bold text-green-700">Điểm: <span id="score">0</span></div>
        </div>

        <div id="question-text" class="question-box">
            <!-- Question will be loaded here -->
        </div>

        <div id="options-container" class="options-grid">
            <!-- Options will be loaded here -->
        </div>

        <div id="message-box" class="message-box">
            <!-- Feedback messages will appear here -->
        </div>

        <div class="controls">
            <button id="hint-button" class="control-button hint">
                Gợi ý
                <span id="hint-text" class="hint-text"></span>
            </button>
            <button id="reset-game-button" class="control-button reset">Chơi lại</button>
        </div>
    </div>

    <canvas id="fireworks-canvas"></canvas>

    <script>
        // Data for questions
        const questions = [
            {
                question: "Anna buys 3 apples. Each apple costs 5 dollars. How much does she pay?",
                options: ["10 dollars", "15 dollars", "20 dollars", "25 dollars"],
                correct: "15 dollars",
                hint: "Anna mua 3 quả táo. Mỗi quả táo giá 5 đô la. Cô ấy phải trả bao nhiêu?",
            },
            {
                question: "A toy costs 45 dollars. John buys 2 toys. How much does he pay?",
                options: ["80 dollars", "85 dollars", "90 dollars", "95 dollars"],
                correct: "90 dollars",
                hint: "Một món đồ chơi giá 45 đô la. John mua 2 món đồ chơi. Anh ấy phải trả bao nhiêu?",
            },
            {
                question: "A pen costs 7 dollars. Mary buys 5 pens. How much does she pay?",
                options: ["30 dollars", "35 dollars", "40 dollars", "45 dollars"],
                correct: "35 dollars",
                hint: "Một cây bút giá 7 đô la. Mary mua 5 cây bút. Cô ấy phải trả bao nhiêu?",
            },
            {
                question: "A cake costs 25 dollars. A juice costs 15 dollars. How much for both?",
                options: ["35 dollars", "40 dollars", "50 dollars", "55 dollars"],
                correct: "40 dollars",
                hint: "Một chiếc bánh giá 25 đô la. Một ly nước ép giá 15 đô la. Cả hai hết bao nhiêu?",
            },
            {
                question: "Anna has 100 dollars. She buys a bag for 60 dollars. How much money is left?",
                options: ["30 dollars", "35 dollars", "40 dollars", "45 dollars"],
                correct: "40 dollars",
                hint: "Anna có 100 đô la. Cô ấy mua một chiếc túi giá 60 đô la. Cô ấy còn lại bao nhiêu tiền?",
            },
            {
                question: "A pair of shoes costs 80 dollars. This is 20 dollars more than a shirt. How much does the shirt cost?",
                options: ["50 dollars", "55 dollars", "60 dollars", "65 dollars"],
                correct: "60 dollars",
                hint: "Một đôi giày giá 80 đô la. Giá này cao hơn một chiếc áo 20 đô la. Chiếc áo giá bao nhiêu?",
            },
            {
                question: "There are 25 students in Class A and 27 students in Class B. How many students in total?",
                options: ["50", "51", "52", "53"],
                correct: "52",
                hint: "Có 25 học sinh ở Lớp A và 27 học sinh ở Lớp B. Tổng cộng có bao nhiêu học sinh?",
            },
            {
                question: "A teacher has 5 boxes of chalk. Each box has 12 pieces. How many pieces in total?",
                options: ["50", "55", "60", "65"], // Changed one 60 to 65 to make options unique
                correct: "60",
                hint: "Một giáo viên có 5 hộp phấn. Mỗi hộp có 12 viên. Tổng cộng có bao nhiêu viên?",
            },
            {
                question: "A book costs 18 dollars. A notebook costs 12 dollars. How much for both?",
                options: ["25 dollars", "28 dollars", "30 dollars", "32 dollars"],
                correct: "30 dollars",
                hint: "Một cuốn sách giá 18 đô la. Một cuốn vở giá 12 đô la. Cả hai hết bao nhiêu?",
            },
            {
                question: "The library has 80 books. 25 books are borrowed. How many books are left?",
                options: ["45 books", "50 books", "55 books", "60 books"],
                correct: "55 books",
                hint: "Thư viện có 80 cuốn sách. 25 cuốn sách đã được mượn. Còn lại bao nhiêu cuốn sách?",
            },
            {
                question: "There are 6 tables in the classroom. Each table has 4 chairs. How many chairs in total?",
                options: ["20 chairs", "22 chairs", "24 chairs", "26 chairs"],
                correct: "24 chairs",
                hint: "Có 6 cái bàn trong lớp học. Mỗi bàn có 4 cái ghế. Tổng cộng có bao nhiêu cái ghế?",
            },
            {
                question: "There are 48 pencils. They are divided equally into 6 boxes. How many pencils in each box?",
                options: ["6", "7", "8", "9"],
                correct: "8",
                hint: "Có 48 cây bút chì. Chúng được chia đều vào 6 hộp. Mỗi hộp có bao nhiêu cây bút chì?",
            },
            {
                question: "A bus has 40 seats. There are 32 passengers. How many empty seats?",
                options: ["6", "7", "8", "9"],
                correct: "8",
                hint: "Một chiếc xe buýt có 40 chỗ ngồi. Có 32 hành khách. Có bao nhiêu chỗ trống?",
            },
            {
                question: "A train travels 60 km each hour. How far in 3 hours?",
                options: ["160 km", "170 km", "180 km", "200 km"],
                correct: "180 km",
                hint: "Một chuyến tàu đi được 60 km mỗi giờ. Nó đi được bao xa trong 3 giờ?",
            },
            {
                question: "A taxi costs 10 dollars per km. A trip is 8 km. How much does it cost?",
                options: ["70 dollars", "80 dollars", "90 dollars", "100 dollars"],
                correct: "80 dollars",
                hint: "Một chiếc taxi giá 10 đô la mỗi km. Một chuyến đi dài 8 km. Chi phí bao nhiêu?",
            },
            {
                question: "There are 24 tourists. Each boat carries 6 people. How many boats are needed?",
                options: ["3", "4", "5", "6"],
                correct: "4",
                hint: "Có 24 khách du lịch. Mỗi thuyền chở 6 người. Cần bao nhiêu thuyền?",
            },
            {
                question: "A bus ticket costs 15 dollars. A return ticket (go and back) costs how much?",
                options: ["25 dollars", "30 dollars", "35 dollars", "40 dollars"],
                correct: "30 dollars",
                hint: "Một vé xe buýt giá 15 đô la. Một vé khứ hồi (đi và về) giá bao nhiêu?",
            },
            {
                question: "Tom walks 5 km each day. How far in 6 days?",
                options: ["25 km", "30 km", "35 km", "40 km"],
                correct: "30 km",
                hint: "Tom đi bộ 5 km mỗi ngày. Anh ấy đi được bao xa trong 6 ngày?",
            },
            {
                question: "There are 5 people in the family. Each person eats 2 eggs for breakfast. How many eggs are eaten?",
                options: ["8", "9", "10", "11"],
                correct: "10",
                hint: "Có 5 người trong gia đình. Mỗi người ăn 2 quả trứng vào bữa sáng. Tổng cộng bao nhiêu quả trứng đã được ăn?",
            },
            {
                question: "Mom buys 3 packs of milk. Each pack has 6 bottles. How many bottles?",
                options: ["16", "17", "18", "19"],
                correct: "18",
                hint: "Mẹ mua 3 gói sữa. Mỗi gói có 6 chai. Tổng cộng bao nhiêu chai?",
            },
            {
                question: "There are 4 rooms. Each room has 2 windows. How many windows in total?",
                options: ["6", "7", "8", "9"],
                correct: "8",
                hint: "Có 4 phòng. Mỗi phòng có 2 cửa sổ. Tổng cộng có bao nhiêu cửa sổ?",
            },
            {
                question: "Dad buys 12 apples. He gives 5 to the children. How many left?",
                options: ["5", "6", "7", "8"],
                correct: "7",
                hint: "Bố mua 12 quả táo. Bố cho trẻ em 5 quả. Còn lại bao nhiêu quả?",
            },
            {
                question: "The family has 3 cars. Each car has 4 wheels. How many wheels in total?",
                options: ["10", "11", "12", "13"],
                correct: "12",
                hint: "Gia đình có 3 chiếc ô tô. Mỗi chiếc ô tô có 4 bánh. Tổng cộng có bao nhiêu bánh xe?",
            },
            {
                question: "The family drinks 2 liters of water per day. How much in 7 days?",
                options: ["10 liters", "12 liters", "14 liters", "16 liters"],
                correct: "14 liters",
                hint: "Gia đình uống 2 lít nước mỗi ngày. Uống bao nhiêu trong 7 ngày?",
            },
            {
                question: "There are 2 teams. Each team has 11 players. How many players in total?",
                options: ["20", "21", "22", "23"],
                correct: "22",
                hint: "Có 2 đội. Mỗi đội có 11 cầu thủ. Tổng cộng có bao nhiêu cầu thủ?",
            },
            {
                question: "A football costs 25 dollars. A basketball costs 30 dollars. How much for both?",
                options: ["45 dollars", "50 dollars", "55 dollars", "60 dollars"],
                correct: "55 dollars",
                hint: "Một quả bóng đá giá 25 đô la. Một quả bóng rổ giá 30 đô la. Cả hai hết bao nhiêu?",
            },
            {
                question: "There are 6 races. Each race has 8 runners. How many runners in total?",
                options: ["46", "47", "48", "49"],
                correct: "48",
                hint: "Có 6 cuộc đua. Mỗi cuộc đua có 8 vận động viên. Tổng cộng có bao nhiêu vận động viên?",
            },
            {
                question: "Each tennis racket costs 40 dollars. 3 rackets cost how much?",
                options: ["100 dollars", "110 dollars", "120 dollars", "130 dollars"],
                correct: "120 dollars",
                hint: "Mỗi cây vợt tennis giá 40 đô la. 3 cây vợt giá bao nhiêu?",
            },
            {
                question: "There are 4 basketball matches. Each match lasts 30 minutes. How many minutes in total?",
                options: ["100", "110", "120", "130"],
                correct: "120",
                hint: "Có 4 trận đấu bóng rổ. Mỗi trận kéo dài 30 phút. Tổng cộng bao nhiêu phút?",
            },
            {
                question: "A swimming pool opens 6 hours a day. How many hours in 5 days?",
                options: ["28 hours", "29 hours", "30 hours", "31 hours"], // Changed one 30 to 31 to make options unique
                correct: "30 hours",
                hint: "Một bể bơi mở cửa 6 giờ một ngày. Mở bao nhiêu giờ trong 5 ngày?",
            },
        ];

        let shuffledQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        const answeredQuestions = new Set(); // Để theo dõi các câu hỏi đã được tính điểm (chỉ khi trả lời đúng lần đầu)
        let currentQuestionAttempted = false; // Cờ để theo dõi xem câu hỏi hiện tại đã được thử (cho logic tính điểm)


        const startScreen = document.getElementById('start-screen');
        const gameContainer = document.getElementById('game-container');
        const startGameButton = document.getElementById('start-game-button');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const messageBox = document.getElementById('message-box');
        const questionCountSpan = document.getElementById('question-count');
        const scoreSpan = document.getElementById('score');
        const hintButton = document.getElementById('hint-button');
        const hintText = document.getElementById('hint-text');
        const resetButton = document.getElementById('reset-game-button');
        const fireworksCanvas = document.getElementById('fireworks-canvas');
        const ctx = fireworksCanvas.getContext('2d');

        // Speech Synthesis setup
        const synth = window.speechSynthesis;
        let utterance = new SpeechSynthesisUtterance();
        utterance.lang = 'en-US'; // Set language to English

        // Fireworks settings
        let particles = [];
        const FIREWORK_COLORS = ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3'];

        // --- Audio Functions (Web Audio API) ---

        // Function to play a correct sound (short high-pitched beep)
        function playCorrectFeedback(message) {
            const feedbackUtterance = new SpeechSynthesisUtterance(message);
            feedbackUtterance.lang = 'en-US';
            synth.speak(feedbackUtterance);
        }

        // Function to play an incorrect sound (short low-pitched beep)
        function playIncorrectFeedback(message) {
            const feedbackUtterance = new SpeechSynthesisUtterance(message);
            feedbackUtterance.lang = 'en-US';
            synth.speak(feedbackUtterance);
        }

        // --- Game Logic Functions ---

        // Fisher-Yates (Knuth) shuffle algorithm
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
            return array;
        }

        function startGame() {
            startScreen.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            resetGame(); // Call reset to initialize and shuffle
        }

        function resetGame() {
            shuffledQuestions = shuffleArray([...questions]); // Create a shuffled copy
            currentQuestionIndex = 0;
            score = 0;
            answeredQuestions.clear(); // Clear previously answered questions (for scoring)
            currentQuestionAttempted = false; // Reset attempt flag for the new game
            updateScoreAndCount();
            displayQuestion();
            hideMessageBox();
            // Clear any active fireworks
            particles = [];
        }

        function updateScoreAndCount() {
            // Cập nhật hiển thị điểm số hiện tại trên tổng số câu hỏi
            scoreSpan.textContent = `${score}/${shuffledQuestions.length}`;
            // Cập nhật hiển thị số câu hỏi
            questionCountSpan.textContent = `${currentQuestionIndex + 1}/${shuffledQuestions.length}`;
            if (currentQuestionIndex >= shuffledQuestions.length) {
                // Khi trò chơi kết thúc, đảm bảo số câu hỏi hiển thị tổng số
                questionCountSpan.textContent = `${shuffledQuestions.length}/${shuffledQuestions.length}`;
            }
        }

        function displayQuestion() {
            if (currentQuestionIndex >= shuffledQuestions.length) {
                showMessageBox("Bạn đã hoàn thành trò chơi! Điểm cuối cùng của bạn là " + score + "/" + shuffledQuestions.length + ".");
                questionText.textContent = "Trò chơi kết thúc!";
                optionsContainer.innerHTML = ''; // Clear options
                return;
            }

            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            questionText.textContent = currentQuestion.question;
            optionsContainer.innerHTML = '';
            hideMessageBox();
            currentQuestionAttempted = false; // Reset for a new question

            // Read the question aloud
            utterance.text = currentQuestion.question;
            synth.speak(utterance);

            currentQuestion.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button');
                button.addEventListener('click', () => checkAnswer(button, option, currentQuestion));
                optionsContainer.appendChild(button);
            });

            // Update hint text
            hintText.textContent = currentQuestion.hint;
        }

        function checkAnswer(selectedButton, selectedOption, currentQuestion) {
            // Disable all option buttons to prevent multiple clicks
            Array.from(optionsContainer.children).forEach(button => {
                button.style.pointerEvents = 'none';
            });

            if (selectedOption === currentQuestion.correct) {
                const feedbackMessages = ["Well done!", "Great!", "Good job!"];
                const randomMessage = feedbackMessages[Math.floor(Math.random() * feedbackMessages.length)];
                playCorrectFeedback(randomMessage); // Play spoken feedback
                selectedButton.classList.add('correct');
                showMessageBox(randomMessage);

                // Add score only if this question hasn't been answered correctly before (first attempt)
                if (!answeredQuestions.has(currentQuestion.question) && !currentQuestionAttempted) {
                    score++;
                    answeredQuestions.add(currentQuestion.question); // Mark as scored
                }
                updateScoreAndCount();

                // Trigger fireworks from the correct button's position
                const rect = selectedButton.getBoundingClientRect();
                createFirework(rect.left + rect.width / 2, rect.top + rect.height / 2);

                setTimeout(() => {
                    currentQuestionIndex++;
                    displayQuestion();
                    // Re-enable buttons for the next question
                    Array.from(optionsContainer.children).forEach(button => {
                        button.style.pointerEvents = 'auto';
                    });
                }, 1500); // Wait for feedback and fireworks
            } else {
                playIncorrectFeedback("Try again!"); // Play spoken feedback
                selectedButton.classList.add('incorrect');
                showMessageBox("Try again!");
                currentQuestionAttempted = true; // Mark that this question has been attempted (incorrectly)

                setTimeout(() => {
                    selectedButton.classList.remove('incorrect');
                    hideMessageBox();
                    // Re-enable buttons after incorrect attempt
                    Array.from(optionsContainer.children).forEach(button => {
                        button.style.pointerEvents = 'auto';
                    });
                }, 1000);
            }
        }

        function showMessageBox(message) {
            messageBox.textContent = message;
            messageBox.classList.add('show');
        }

        function hideMessageBox() {
            messageBox.classList.remove('show');
        }

        // --- Fireworks Animation ---

        function resizeCanvas() {
            fireworksCanvas.width = window.innerWidth;
            fireworksCanvas.height = window.innerHeight;
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.radius = Math.random() * 2 + 1;
                this.velocity = {
                    x: (Math.random() - 0.5) * 8,
                    y: (Math.random() - 0.5) * 8
                };
                this.alpha = 1;
                this.friction = 0.95;
                this.gravity = 0.2;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.restore();
            }

            update() {
                this.velocity.x *= this.friction;
                this.velocity.y *= this.friction;
                this.velocity.y += this.gravity;
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                this.alpha -= 0.015;
            }
        }

        function createFirework(x, y) {
            const particleCount = 50;
            const color = FIREWORK_COLORS[Math.floor(Math.random() * FIREWORK_COLORS.length)];
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        function animateFireworks() {
            requestAnimationFrame(animateFireworks);
            ctx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);

            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.update();
                p.draw();

                if (p.alpha <= 0.1 || p.radius <= 0.5) {
                    particles.splice(i, 1);
                }
            }
        }

        // --- Event Listeners ---
        startGameButton.addEventListener('click', startGame);
        resetButton.addEventListener('click', resetGame);

        // Hint button logic
        hintButton.addEventListener('mousedown', () => {
            hintText.classList.add('show-hint'); // Add show-hint class to the hint text
        });

        hintButton.addEventListener('mouseup', () => {
            hintText.classList.remove('show-hint'); // Remove show-hint class from the hint text
        });

        // For touch devices
        hintButton.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Prevent default touch behavior like scrolling
            hintText.classList.add('show-hint'); // Add show-hint class to the hint text
        }, { passive: false });

        hintButton.addEventListener('touchend', () => {
            hintText.classList.remove('show-hint'); // Remove show-hint class from the hint text
        });

        // Initial setup
        window.addEventListener('load', () => {
            resizeCanvas();
            animateFireworks();
        });
        window.addEventListener('resize', resizeCanvas);

    </script>
</body>
</html>
